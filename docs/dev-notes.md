# workctl — Developer Notes

Critical points discovered during development. Update this file whenever a new gotcha, fix, or non-obvious decision is made.

---

## GUI — ProjectContext & Null Safety

### Always null-guard ProjectContext listeners
When a project is deleted (or deselected), `ProjectContext.setCurrentProject(null)` is called and **all registered listeners fire with `null`**. Every controller that registers a listener must guard against it:

```java
ProjectContext.addListener(project -> {
    currentProject = project;
    if (project == null) return;   // ← required, or NPE on Path.resolve(null)
    loadData(project);
});
```

Affected controllers: `LogController`, `StatsController`, `TaskController` (already guarded in `refreshBoard()`).

### Clearing UI state on project deletion
When `setProject(null)` is called, `refreshBoard()` returns early — but the old content stays visible. Always clear the UI explicitly when the project is null:

```java
private void refreshBoard() {
    if (currentProject == null) {
        openColumn.getChildren().clear();
        inProgressColumn.getChildren().clear();
        doneColumn.getChildren().clear();
        return;
    }
    // ...
}
```

Apply the same pattern to any panel that displays project-scoped data.

---

## Gradle — Build Script Rules

### `ext {}` must be declared before any task that uses it
Groovy evaluates `build.gradle` top-to-bottom at configuration time. If a task references `isWindows` (or any `ext` property) and the `ext {}` block appears further down the file, Gradle throws `MissingPropertyException` at configuration time — even if the task body is inside `doLast`.

**Rule:** Keep the `ext {}` OS-detection block at the top of `cli/build.gradle`, before all task registrations.

```groovy
// ✓ Correct — ext defined first
ext {
    isWindows = org.gradle.internal.os.OperatingSystem.current().isWindows()
    ...
}

tasks.register('myTask', Exec) {
    if (isWindows) { ... }   // safe
}
```

### Gradle 9: no `exec {}` inside `doLast` on a `DefaultTask`
`project.exec {}` was removed as a dynamic method in Gradle 9. If you need to shell out from a task, use the `Exec` task type directly — not a plain `tasks.register('foo')` with `exec` inside `doLast`.

```groovy
// ✗ Breaks on Gradle 9
tasks.register('foo') {
    doLast { exec { commandLine ... } }   // MissingMethodException
}

// ✓ Correct
tasks.register('foo', Exec) {
    commandLine 'sh', '-c', '...'
}
```

---

## CLI — Shell Tab Completion

### Completion script must be regenerated after adding new commands
The file `~/.workctl/workctl_completion` is a **static snapshot**. It is auto-regenerated by the `generateCompletion` Gradle task which runs as a finalizer of `installDist`. This covers the normal dev workflow, but if you add commands and test them without running `installDist`, completions will be stale.

To regenerate manually:
```bash
workctl generate-completion bash > ~/.workctl/workctl_completion
```

### Completion does not work on Windows CMD / PowerShell
The generated script is bash/zsh syntax. The `generateCompletion` Gradle task detects Windows via `isWindows` and prints a skip message instead of failing the build. Windows users on Git Bash or WSL can source it manually.

### CLI binary is named `workctl`, not `cli`
The install path is:
```
cli/build/install/workctl/bin/workctl      ← macOS/Linux
cli/build/install/workctl/bin/workctl.bat  ← Windows
```
Not `cli/build/install/cli/bin/cli` (the CLAUDE.md example is outdated).

---

## GUI — File Watching

### WatchService is shared across LogController and StatsController
`ProjectContext.watchProjectDir()` maintains a **single** `WatchService`. Both `LogController` and `StatsController` call it when a project is selected — the second call silently replaces the first, which is fine since both always watch the same `notes/` directory.

Do not create a second independent WatchService in a new controller. Call `ProjectContext.watchProjectDir()` and register a `fileChangeListener` instead.

### `MainController` watches `01_Projects/` separately
`MainController.startWorkspaceWatcher()` watches the projects directory for `ENTRY_CREATE` and `ENTRY_DELETE` to auto-refresh the project list when the CLI creates or removes a project. This is separate from the per-project file watcher above.

---

## Core — Task & Project Data

### Task format is split across two files
`Task.java` owns `toMarkdown()` and `fromMarkdownBlock()`. `TaskService.java` owns file I/O and block parsing. Any change to the Markdown format requires updating **both** files.

### Metadata is stored as invisible HTML comments
```markdown
1. [ ] (P2) Task title  <!-- created=2026-02-20 -->
```
Parsers that strip HTML comments will lose metadata silently. Keep this in mind when writing any export or import feature.

### Deleting a project is irreversible
`ProjectService.deleteProject()` does a recursive `Files.walk()` delete with no trash/backup step. There is no undo. Both CLI and GUI require the user to retype the project name before deletion proceeds.

---

## Cross-Platform

### Always check `isWindows` before using `sh -c`
Any Gradle task or code that shells out must branch on the OS:

```groovy
if (isWindows) {
    commandLine 'cmd', '/c', '...'
} else {
    commandLine 'sh', '-c', '...'
}
```

The binary extension also differs: `workctl` on macOS/Linux, `workctl.bat` on Windows.

---

*Last updated: 2026-02-21*
