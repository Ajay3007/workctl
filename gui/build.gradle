import org.gradle.internal.os.OperatingSystem

plugins {
    id 'application'
    id 'org.openjfx.javafxplugin' version '0.1.0'
}

java {
    sourceCompatibility = JavaVersion.VERSION_17
    targetCompatibility = JavaVersion.VERSION_17
}

javafx {
    version = "21"
    modules = ['javafx.controls', 'javafx.fxml', 'javafx.web']
}

dependencies {
    implementation project(':core')
    implementation project(':config')
    implementation project(':agent')
    implementation 'org.commonmark:commonmark:0.21.0'
    implementation 'org.commonmark:commonmark-ext-gfm-tables:0.21.0'
    implementation 'org.apache.pdfbox:pdfbox:2.0.30'
}

application {
    mainClass       = 'com.workctl.gui.WorkctlApp'
    applicationName = 'workctl-gui'
}

jar {
    manifest {
        attributes(
                'Main-Class':             application.mainClass.get(),
                'Implementation-Title':   'workctl GUI',
                'Implementation-Version': version
        )
    }
}

// ── Platform detection ────────────────────────────────────────────
def os = OperatingSystem.current()

// ── JavaFX native paths ───────────────────────────────────────────
//
//  Set these ONCE in ~/.gradle/gradle.properties (never commit them):
//
//  macOS / Linux:
//    javafxJmods=/Users/you/javafx-sdk-21/javafx-jmods-21
//    javafxBin=/Users/you/javafx-sdk-21/lib
//
//  Windows:
//    javafxJmods=C:/javafx-sdk-21/javafx-jmods-21
//    javafxBin=C:/javafx-sdk-21/bin
//
//  Download JavaFX SDK: https://gluonhq.com/products/javafx/
//  (choose the matching platform, SDK type, Java 21)
//
ext {
    javafxJmods = project.findProperty('javafxJmods') ?: ''
    javafxBin   = project.findProperty('javafxBin')   ?: ''
}

// ── Clean previous package output ────────────────────────────────
tasks.register('cleanPackage') {
    group       = 'workctl distribution'
    description = 'Remove previous packaged output from build/release/'
    outputs.upToDateWhen { false }   // always run — jpackage fails if output dir exists
    doLast {
        def releaseDir = file("${rootDir}/build/release")
        releaseDir.mkdirs()
        releaseDir.listFiles()?.each { f ->
            if (f.name.startsWith('workctl-gui')) {
                if (f.isDirectory()) f.deleteDir() else f.delete()
            }
        }
    }
}

// ── Package as a native self-contained app ────────────────────────
//
//  Uses jpackage + jlink to bundle a trimmed JRE + JavaFX into a
//  single distributable — no Java installation needed on target.
//
//  Output per platform:
//    macOS   → build/release/workctl-gui.dmg
//              Open DMG → drag workctl-gui.app to /Applications → double-click
//
//    Windows → build/release/workctl-gui/workctl-gui.exe
//              Zip the workctl-gui/ folder and send it — double-click .exe
//
//    Linux   → build/release/workctl-gui_<version>_amd64.deb
//              Install with:  sudo dpkg -i workctl-gui*.deb
//
//  Requires: javafxJmods set in ~/.gradle/gradle.properties (see above)
//
//  Run:    ./gradlew :gui:packageApp
//
tasks.register('packageApp', Exec) {
    group       = 'workctl distribution'
    description = 'Package GUI as a native self-contained app (no Java needed on target)'
    dependsOn   installDist, cleanPackage

    doFirst {
        // ── Guard: fail early with a helpful message ─────────────
        if (!javafxJmods || javafxJmods.toString().isBlank()) {
            throw new GradleException("""
╔══════════════════════════════════════════════════════════════════╗
║              JavaFX path not configured                          ║
╠══════════════════════════════════════════════════════════════════╣
║  Add the following to  ~/.gradle/gradle.properties              ║
║  (create the file if it doesn't exist):                          ║
║                                                                  ║
║  macOS / Linux:                                                  ║
║    javafxJmods=/path/to/javafx-jmods-21                         ║
║    javafxBin=/path/to/javafx-sdk-21/lib                         ║
║                                                                  ║
║  Windows:                                                        ║
║    javafxJmods=C:/path/to/javafx-jmods-21                       ║
║    javafxBin=C:/path/to/javafx-sdk-21/bin                       ║
║                                                                  ║
║  Download JavaFX SDK (Java 21, your platform):                   ║
║    https://gluonhq.com/products/javafx/                          ║
╚══════════════════════════════════════════════════════════════════╝
""")
        }

        def outDir = file("${rootDir}/build/release")
        def libDir = file("${buildDir}/install/workctl-gui/lib").absolutePath
        outDir.mkdirs()

        // Package type: app-image on Windows/macOS (portable self-contained folder/bundle),
        //               deb on Linux (apt-installable package).
        //
        // macOS note: 'dmg' requires version to start with a digit ≥ 1.
        // 'app-image' produces a .app bundle — double-click to run, zip to share.
        def pkgType = os.isLinux() ? 'deb' : 'app-image'

        // macOS (and Windows) jpackage requires version to start with 1-9.
        // Project version 0.1.0 → package version 1.1.0 (adds 1 to the major).
        def pkgVersion = version.toString().startsWith('0.')
            ? '1.' + version.toString().replaceFirst('^0\\.', '')
            : version.toString()

        def jpackageExe = new File(System.getProperty('java.home'),
                os.isWindows() ? 'bin/jpackage.exe' : 'bin/jpackage').absolutePath

        def cmd = [
            jpackageExe,
            '--type',         pkgType,
            '--name',         'workctl-gui',
            '--app-version',  pkgVersion,
            '--input',        libDir,
            '--main-jar',     "gui-${version}.jar",
            '--main-class',   application.mainClass.get(),
            '--dest',         outDir.absolutePath,
            // jlink uses the jmods to build a trimmed JRE with JavaFX baked in
            '--module-path',  javafxJmods,
            '--add-modules',  'javafx.controls,javafx.fxml,javafx.web',
            // JVM flags passed to the bundled launcher
            '--java-options', '--add-opens=java.base/java.lang=ALL-UNNAMED',
            '--java-options', '--add-opens=java.base/java.io=ALL-UNNAMED',
            '--java-options', '--add-exports=javafx.graphics/com.sun.javafx.application=ALL-UNNAMED',
        ]

        // Platform-specific icon
        if (os.isWindows()) {
            def icon = file("src/main/resources/icon.ico")
            if (icon.exists()) cmd += ['--icon', icon.absolutePath]
        } else if (os.isMacOsX()) {
            def icon = file("src/main/resources/icon.icns")
            if (icon.exists()) cmd += ['--icon', icon.absolutePath]
            // App name shown in macOS menu bar / About dialog
            cmd += ['--mac-package-name', 'workctl']
        } else {
            def icon = file("src/main/resources/icon.png")
            if (icon.exists()) cmd += ['--icon', icon.absolutePath]
        }

        commandLine = cmd
    }

    doLast {
        // Windows: jpackage occasionally misses native JavaFX DLLs — copy them in
        if (os.isWindows() && javafxBin) {
            def runtimeBin = file("${rootDir}/build/release/workctl-gui/runtime/bin")
            def srcBin     = file(javafxBin)
            if (runtimeBin.exists() && srcBin.exists()) {
                println "  Copying JavaFX native DLLs..."
                srcBin.listFiles()?.findAll { it.name.endsWith('.dll') }?.each { f ->
                    def dest = new File(runtimeBin, f.name)
                    if (!dest.exists()) {
                        java.nio.file.Files.copy(
                            f.toPath(), dest.toPath(),
                            java.nio.file.StandardCopyOption.REPLACE_EXISTING)
                    }
                }
            }
        }

        // macOS: re-sign the bundle with JVM entitlements so Finder can launch it.
        // jpackage produces an ad-hoc signature without the entitlements the JVM
        // needs (JIT, unsigned executable memory, library validation bypass).
        // Without these, Gatekeeper blocks double-click launch on macOS 15+.
        if (os.isMacOsX()) {
            def appBundle    = file("${rootDir}/build/release/workctl-gui.app").absolutePath
            def entitlements = file("src/main/resources/macos-entitlements.plist").absolutePath
            println "  Re-signing bundle with JVM entitlements..."
            def proc = new ProcessBuilder(
                    'codesign', '--force', '--deep', '--sign', '-',
                    '--entitlements', entitlements, '--options', 'runtime', appBundle)
                .inheritIO()
                .start()
            def rc = proc.waitFor()
            if (rc != 0) throw new GradleException("codesign failed (exit ${rc})")
            println "  Signed: ${appBundle}"
        }

        println ""
        println "══════════════════════════════════════════════════════"
        if (os.isWindows()) {
            println "  ✓  Packaged → build/release/workctl-gui/"
            println ""
            println "  To share:  zip the workctl-gui/ folder"
            println "  To run:    workctl-gui/workctl-gui.exe"
            println "  No Java or JavaFX needed on the target machine."
        } else if (os.isMacOsX()) {
            println "  ✓  Packaged → build/release/workctl-gui.app"
            println ""
            println "  To share:  zip the workctl-gui.app bundle and send it"
            println "  To run:    double-click workctl-gui.app"
            println "             (first launch: System Settings → Privacy & Security → Open Anyway)"
            println "  No Java or JavaFX needed on the target machine."
        } else {
            println "  ✓  Packaged → build/release/workctl-gui*.deb"
            println ""
            println "  To install:  sudo dpkg -i build/release/workctl-gui*.deb"
            println "  To run:      workctl-gui"
        }
        println "══════════════════════════════════════════════════════"
    }
}

// ── packageNative — kept as backward-compatible alias ─────────────
tasks.register('packageNative') {
    group       = 'workctl distribution'
    description = 'Alias for packageApp (kept for backward compatibility)'
    dependsOn   packageApp
}

// ── packageZip — ready-to-share archive ──────────────────────────
//
//  macOS:   gui/build/distributions/workctl-gui-<v>-macos.zip
//             (contains the .dmg — share and open to install)
//
//  Windows: gui/build/distributions/workctl-gui-<v>-windows.zip
//             (contains the app folder — unzip and run .exe)
//
//  Linux:   gui/build/distributions/workctl-gui-<v>-linux.zip
//             (contains the .deb)
//
//  Run:  ./gradlew :gui:packageZip
//
tasks.register('packageZip') {
    group           = 'workctl distribution'
    description     = 'Create a ready-to-share zip of the packaged app'
    dependsOn       packageApp

    doLast {
        def platform = os.isWindows() ? 'windows' : (os.isMacOsX() ? 'macos' : 'linux')
        def distDir  = new File("${buildDir}/distributions")
        distDir.mkdirs()
        def zipPath  = new File(distDir, "workctl-gui-${version}-${platform}.zip").absolutePath

        if (os.isMacOsX()) {
            // Use system zip — Gradle's Zip task strips Unix execute permissions,
            // which breaks the binary inside .app bundles on macOS.
            def proc = new ProcessBuilder('zip', '-r', zipPath, 'workctl-gui.app')
                    .directory(file("${rootDir}/build/release"))
                    .inheritIO()
                    .start()
            if (proc.waitFor() != 0) throw new GradleException("zip failed")
        } else if (os.isWindows()) {
            ant.zip(destfile: zipPath) {
                zipfileset(dir: "${rootDir}/build/release/workctl-gui", prefix: 'workctl-gui')
            }
        } else {
            ant.zip(destfile: zipPath) {
                zipfileset(dir: "${rootDir}/build/release", includes: '*.deb')
            }
        }
        println "✓ ZIP → gui/build/distributions/workctl-gui-${version}-${platform}.zip"
    }
}

tasks.named('run') {
    doFirst {
        println "──────────────────────────────────────────"
        println "  Launching workctl GUI (development mode)"
        println "──────────────────────────────────────────"
    }
}
